---
title: JVM类加载机制
date: 2018-02-13 19:21:17
categories: Java
---

Java 虚拟机一般使用 Java 类的流程为：首先将开发者编写的 Java 源代码（.java文件）编译成 Java 字节码（.class文件），然后类加载器会读取这个 .class 文件，并转换成 java.lang.Class 的实例。有了该 Class 实例后，Java 虚拟机可以利用 newInstance 之类的方法创建其真正对象了。而这个过程，就是JVM的类加载。
### 概念

虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这就是虚拟机的类加载机制。

### 过程

类加载的过程包括了加载、验证、准备、解析、初始化五个阶段。在这五个阶段中，加载、验证、准备和初始化这四个阶段发生的顺序是确定的，而解析阶段则不一定，它在某些情况下可以在初始化阶段之后开始，这是为了支持Java语言的运行时绑定（也成为动态绑定或晚期绑定）。另外注意这里的几个阶段是按顺序开始，而不是按顺序进行或完成，因为这些阶段通常都是互相交叉地混合进行的，通常在一个阶段执行的过程中调用或激活另一个阶段。

### Class文件的来源

* 开发者编写的类
* Java内部自带的核心类
* Java核心扩展类
* 动态加载远程的.class文件

> 这些文件分别由AppClassLoader（系统加载器）、BootstrapClassLoader(启动类加载器)、ExtClassLoader（类扩展加载器)和自定义的ClassLoader进行加载

### 双亲加载机制

某个特定的类加载器在接到加载类的请求时，首先将加载任务委托给父类加载器，依次递归，如果父类加载器可以完成类加载任务，就成功返回；只有父类加载器无法完成此加载任务时，才自己去加载。

#### 实现过程

1. 检查目标.class文件是否加载过，如果加载过则直接返回
2. 如果没加载过，把加载请求传递给父类加载器去加载
3. 如果父类加载器加载成功，则直接返回
4. 如果父类加载器未加载到，则自身加载

