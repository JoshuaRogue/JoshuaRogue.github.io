---
title: 传输层协议：UDP与TCP（三）
date: 2018-11-15 14:41:03
categories: Android网络开发
---

#### TCP滑动窗口

TCP的窗口管理将正确接收段的确认和接收端的接收缓冲区分配分离开来。例如，假设接收端有一个4096字节的缓冲区，如下图所示。

![tcp21.PNG](https://i.loli.net/2018/11/15/5bed35516ae56.png)

详细过程如下：

1. 如果发送了一个2048字节的数据段，并且该数据段已被正确地接收，那么，接收端将确认该数据段。然而，由于接收端现在只剩下2048字节的缓冲区空间（在应用程序从缓冲区取走数据之前），所以它将宣告下一个期望字节开始窗口为2048。
2. 发送端又传输了另一个2048字节长的段，该段被确认了，但是接收端宣告的窗口大小变成了0。因此，发送端不得不停止，等待接收主机上的应用程序从缓冲区取走一些数据。到那时候，TCP实体可以向发送端宣告一个更大的窗口，发送端才能发送数据。
3. 当窗口变为0时，发送端不能如通常那样发送段了，但这里有两种意外情形。第一，紧急数据仍可以发送，比如，允许用户杀掉远程机器上运行的某一个进程。第二，*发送端可以发送一个1字节的段，以便强制接收端重新宣告下一个期望的字节和窗口大小，这种数据包称为窗口探测。TCP标准明确地提供了这个选项，来防止窗口更新数据包丢失后发生死锁。*
4. 发送端并不一定一接到应用程序传递来的数据马上将数据传送出去；同样，接收端也不一定必须尽可能快地发送确认段。TCP实体可以充分利用这种自由度来提高传输性能。

##### TCP性能问题

###### 带宽紧缺

> 带宽：是指在固定的时间可传输的资料数量，亦即在传输管道中可以传递数据的能力。

在带宽紧缺的场合，在同一时间间隔内多次发送应答报文不合适，会浪费珍贵的带宽资源

解决方法：延迟确认，基本想法是将确认和窗口更新延迟50毫秒，希望能够获得一些数据免费搭载过去。不过尽管通过延迟确认减少了接收端给与网络的负载，但是发送端发送多个小数据包的工作方式依然非常低效。避免这种用法的一种方法是采用Nagle算法：当数据每次以很少量方式进入到发送端时，发送端只是发送第一次到达的数据字节，然后将其余后面到达的字节缓冲起来，直到发送出去的那个数据包被确认。然后将所有缓冲的字节放在一个TCP段中发送出去，并且继续开始缓冲字节，直到下一个段被确认。这种算法可以大大地减少所需的带宽。

> 当需要一个快速的短数据包流时（比如在Internet上玩互动游戏时），可以禁用Nagle算法

###### 低能窗口综合症

当每次接收端缓冲区只有1个字节的空闲，而发送端也发送一字节，接收端也对这1字节的数据段进行确认，同时设置窗口大小为0。这种行为可能会永久地持续下去。

解决方法：如同发送端的TCP一样，接收端的TCP也可以缓冲数据，它可以阻塞上层应用的读请求，直至它累积来大块的数据。这样做可以减少调用TCP的次数，而从减少额外的开销。当然，这样做也增加了响应的时间，但是，对于像文件传输这样的非交互式应用来说，效率可能比单个请求的响应时间更加重要。

###### 数据段乱序

乱序到达的数据段到达时，没有什么比丢弃乱序到达的段更糟糕的事，因为丢弃这些段，那么它们将被发送端重传。

解决方法：只有当确认字节之前的所有数据都到达之后才能发送确认，这种方法称为累计确认。如果接收端已经获得0、1、2、4、5、6、7，它可以确认直到段2（包括段2）之前的数据。当发送端超时，然后重发段3.因为接收端已经缓冲了段4~段7，一旦它收到段3就可以立即确认直到段7的全部字节。

..未完