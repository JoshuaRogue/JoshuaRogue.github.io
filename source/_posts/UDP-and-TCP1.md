---
title: 传输层协议：UDP与TCP（二）
date: 2018-11-13 15:19:34
categories: Android网络开发
---

#### TCP连接建立

TCP使用了三次握手法来建立连接，如下图所示

![捕获1.PNG](https://i.loli.net/2018/11/13/5bea910814091.png)

TCP三次握手详细过程：

1. 客户机器A上的一个应用程序发出连接请求，本地的TCP实体创建一条连接记录，并将它标记为SYN SENT状态，然后发送一个SYN段，此SYN段中包含了主机A选择的序号x
2. 服务器执行监听，当收到一个SYN时，服务器就确认该段发出SYN+ACK并且进入到SYN RCVD状态。其中ACK段是作为对x的确认，同时宣告自己的初始序号y
3. 最后，主机1对服务器选择的序号进行确认，当主机A发出最后一个ACK段后，主机A切换到ESTABLISHED状态，服务器收到ACK段后也切换到ESTACLISHED状态

##### 三次握手的漏洞

* SYN泛洪

当监听进程接受一个连接请求，并立即以SYN段作为响应时，它必须记住该SYN段的序号。这意味着一个恶意的发送端很容易地占据一个主机资源。具体的做法是这样的：恶意用户绵绵不断地发送SYN段请求服务器连接，但又故意不完成连接建立的后续过程，由此可消耗掉一台主机的资源。这种攻击称为SYN泛洪。

抵御这种攻击的一种方法是使用SYN“小甜饼”（SYN Cookie）。主机不去记忆序号，而是选择一个加密生成的序号，将它放在出境段中，并且忘记它。如果三次握手完成后，该序号（加1）将返回主机。主机运行相同的加密函数进行解密，重新生成正确的序号。这个过程允许主机检查确认号是否正确，而不必记住单独的序号。这里存在一些注意事项，比如无法处理TCP选项，所以只有当主机容易受到SYN泛洪时，才可以使用SYN Cookie。

* 其他

如伪造连接，可使用伪随机的初始序号，保证在一个时间间隔内初始序号不能重复，防止序号回绕（PAWS）

...未完
