---
title: 图片模块的三级缓存
date: 2018-04-04 09:48:24
categories: Android
---

> Android应用中不可避免的需要显示很多图片，但是如果每次都从网络拉取，就极大地影响了图片加载速度和浪费用户流量，但内存又是系统十分珍贵的资源，无法将图片都缓存进内存

### 概述

Android平台上比较流行的图片框架，如Fresco和其他的图片框架，基本上都使用了三级缓存，即“内存-本地-网络”来实现。

##### 三级缓存工作流程

首先应用程序访问网络拉取图片，分别将加载的图片保存在本地SD卡和内存中，当程序再一次需要加载图片时，先判断内存中是否有缓存，有则直接从内存中拉取，否则查看本地缓存目录中是否有缓存，本地缓存目录中如果存在缓存，则从本地缓存卡中拉取，否则从网络加载图片。

#### 内存缓存

使用LruCache（类型安全、不允许空值和null值）来实现图片内存管理是一种可靠的方式，它的主要算法原理是把最近使用的对象用强引用存储在LinkedHashMap中，并且把最近最少使用的对象在缓存值达到预设值之前从内存中移除。

LruCache中重写sizeOf（String key，Bitmap value），这个方法是必须重写的，返回加入的缓存对象大小。

##### Bitmap内存复用

Android是从3.0版本开始支持Bitmap内存复用，也就是BitmapFactory.Options.inBitmap属性，如果这个属性被设置有效的目标复用对象，decode方法就在加载内容时重用已经存在的Bitmap。这意味着Bitmap的内存被重新利用，这可以减少内存的分配与回收，提高图片的性能。

#### 磁盘缓存

内存缓存用着固然方便，但是内存是属于比较宝贵的资源，一旦使用带有大数据的组件，很快就会填满内存，所以说引入磁盘缓存是很有必要的。

要用磁盘缓存，我们一般会缓存到SD卡，DiskLruCache是我们经常使用的一个管理磁盘缓存的类。我们使用它可以在程序中把从网络加载的数据保存到磁盘上作为缓存数据。

DiskLruCache也是使用的最近最少使用算法，通过journal文件（journal文件是DiskLruCache的一个日志文件），并包装了数据存储的各类操作方法。


